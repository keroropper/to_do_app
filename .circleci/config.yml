version: 2.1

orbs: 
  ruby: circleci/ruby
  node: circleci/node 

# このプロジェクトで実行するジョブの定義
jobs: 
  build-and-test:
    docker:
      - image: circleci/ruby:3.2.1-node-browsers
    working_directory: ~/repo
    steps: 
      - checkout
      - setup_remote_docker:
      - restore_cache:
        keys:
          - v1-dependencies-{{ checksum "Gemfile.lock" }}
          - v1-dependencies-{{ checksum "yarn.lock" }}
          - v1-dependencies-
      - run: 
        name: Bundle install
          command: |
            bundle install --path ./vendor/bundle
      - save_cache:
        paths: 
          - ./vendor/bundle
        keys:
          - v1-dependencies-{{ checksum "Gemfile.lock" }}
          - v1-dependencies-{{ checksum "yarn.lock" }}
      - run: 
        name: build and test
        command: |
          docker-compose build
          docker-compose run web bundle exec rails db:create
          docker-compose run web bundle exec rails db:migrate
          docker-compose run web yarn install --check-files
          docker-compose run web bundle exec rails webpacker:compile
          docker-compose run web bundle exec rspec

workflows: 
  version: 2.1
  jobs:
    - build-and-test

